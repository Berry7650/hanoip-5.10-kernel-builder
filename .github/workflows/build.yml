name: Android Kernel Build (disk-optimized) + AnyKernel3 + KernelSU (auto-detect KERNEL_DIR)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-22.04
    env:
      ARCH: arm64
      # আপনার defconfig যদি আলাদা নাম হয় তাহলে এখানে পরিবর্তন করুন বা repo secret/env ব্যবহার করুন
      DEFCONFIG: hanoip_defconfig
      # যদি আপনার রেপোতে stock_boot.img বা ramdisk থাকে, set to "true"
      USE_STOCK_RAMDISK: "false"

    steps:
    - name: Checkout source (with submodules)
      uses: actions/checkout@v4
      with:
        submodules: 'recursive'

    - name: Quick repo scan (debug)
      run: |
        echo "Top-level files:"
        ls -la
        echo "Searching for potential kernel roots (Makefile + arch/arm64)..."
        find . -maxdepth 6 -type f -name Makefile -printf '%h\n' | sort -u | while read d; do
          echo "Candidate: $d"
          if [ -d "$d/arch/arm64" ]; then
            echo " -> has arch/arm64"
          fi
        done

    - name: Detect kernel source root
      id: detect_kernel
      run: |
        KERNEL_DIR=""
        # খোঁজ: কোনো সাব-ডিরেক্টরি যা একটি Makefile রাখে এবং সেই ডিরেক্টরেই arch/arm64 আছে
        # maxdepth 6: দরকারে বড় করে নিন
        for d in $(find . -maxdepth 6 -type f -name Makefile -printf '%h\n' | sort -u); do
          if [ -d "$d/arch/arm64" ]; then
            KERNEL_DIR="$d"
            break
          fi
        done
        if [ -z "$KERNEL_DIR" ]; then
          echo "ERROR: kernel root not found under repo. Please set KERNEL_DIR manually as env."
          ls -la
          exit 1
        fi
        # normalize and export
        KERNEL_DIR=${KERNEL_DIR#./}
        echo "Detected kernel dir: $KERNEL_DIR"
        echo "KERNEL_DIR=$KERNEL_DIR" >> $GITHUB_ENV
        echo "::set-output name=kernel_dir::$KERNEL_DIR"

    - name: Install build dependencies (lightweight)
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends \
          build-essential bc bison flex libssl-dev \
          libncurses5-dev libncursesw5-dev python3 python3-pip \
          ccache rsync unzip zip abootimg zstd \
          clang lld llvm binutils-aarch64-linux-gnu gcc-aarch64-linux-gnu
        ccache --version || true

    - name: Limit ccache size (prevent runaway)
      run: |
        mkdir -p ~/.ccache
        # set max cache to 1G
        ccache --max-size=1G
        echo "ccache status:"
        ccache -s || true

    - name: Show toolchain versions (logs)
      run: |
        echo "clang:"
        clang --version | head -n 2 || true
        echo "lld:"
        ld.lld --version 2>/dev/null || echo "ld.lld not available"
        echo "aarch64-gcc:"
        aarch64-linux-gnu-gcc --version | head -n 1 || true
        df -h .

    - name: Configure kernel (defconfig)
      # run make in detected kernel root
      working-directory: ${{ env.KERNEL_DIR }}
      env:
        ARCH: ${{ env.ARCH }}
        CROSS_COMPILE: aarch64-linux-gnu-
      run: |
        echo "Working directory: $(pwd)"
        echo "List top-level in kernel dir:"
        ls -la | sed -n '1,120p'
        echo "List arch/arm64/configs (if exists):"
        ls -la arch/arm64/configs || true
        # Try the provided DEFCONFIG; if it fails, print configs and exit non-zero
        if make O=out ARCH=${ARCH} ${DEFCONFIG}; then
          echo "Used ${DEFCONFIG}"
        else
          echo "DEFCONFIG ${DEFCONFIG} failed — listing available configs"
          ls -la arch/arm64/configs || true
          # fail early so you can inspect logs and set correct DEFCONFIG
          exit 1
        fi

    - name: Build kernel (clang, disk-optimized flags)
      working-directory: ${{ env.KERNEL_DIR }}
      env:
        ARCH: ${{ env.ARCH }}
        CROSS_COMPILE: aarch64-linux-gnu-
      run: |
        export CC=clang
        export LD=ld.lld
        export LLVM=1
        export LLVM_IAS=1
        export CROSS_COMPILE=aarch64-linux-gnu-
        JOBS=$(nproc)
        echo "Building with JOBS=$JOBS in $(pwd)"
        make -j${JOBS} O=out ARCH=${ARCH} CC=${CC} LD=${LD} CROSS_COMPILE=${CROSS_COMPILE} LLVM=${LLVM} LLVM_IAS=${LLVM_IAS}

    - name: Build modules (best-effort)
      if: always()
      working-directory: ${{ env.KERNEL_DIR }}
      env:
        ARCH: ${{ env.ARCH }}
        CROSS_COMPILE: aarch64-linux-gnu-
      run: |
        set -e
        make O=out ARCH=${ARCH} CROSS_COMPILE=${CROSS_COMPILE} modules || true
        make O=out ARCH=${ARCH} CROSS_COMPILE=${CROSS_COMPILE} INSTALL_MOD_PATH=modules_pkg modules_install || true

    - name: Collect raw build artifacts (upload)
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: kernel-raw-artifacts
        path: |
          ${{ env.KERNEL_DIR }}/out/arch/arm64/boot/Image
          ${{ env.KERNEL_DIR }}/out/arch/arm64/boot/Image.gz
          ${{ env.KERNEL_DIR }}/out/arch/arm64/boot/Image.gz-dtb
          ${{ env.KERNEL_DIR }}/out/arch/arm64/boot/dts/**/*.dtb
          ${{ env.KERNEL_DIR }}/out/arch/arm64/boot/dtbo.img
          modules_pkg/**

    ####################################################################
    # AnyKernel3 template (prepare before KernelSU integration)
    ####################################################################

    - name: Prepare AnyKernel3 template (shallow)
      run: |
        git clone --depth=1 https://github.com/osm0sis/AnyKernel3 anykernel || true
        ls -la anykernel || true

    ####################################################################
    # KernelSU steps (best-effort)
    ####################################################################

    - name: Clone KernelSU (shallow)
      run: |
        git clone --depth=1 https://github.com/tiann/KernelSU.git kernelsu || true
        ls -la kernelsu || true

    - name: Attempt KernelSU LKM build (best-effort)
      working-directory: kernelsu
      env:
        ARCH: ${{ env.ARCH }}
        CROSS_COMPILE: aarch64-linux-gnu-
      run: |
        set -eo pipefail
        # try common build script targets if present
        if [ -x build/build.sh ]; then
          export CC=clang
          export CROSS_COMPILE=aarch64-linux-gnu-
          ./build/build.sh lkm || true
        fi
        # fallback make
        if [ -f Makefile ]; then
          make -j$(nproc) || true
        fi
        # gather artifacts (if any)
        mkdir -p ksuresult
        find . -type f -name "*.ko" -o -name "ksu*" -o -name "*.so" -print0 | xargs -0 -I{} cp -v --parents "{}" ksuresult/ || true
        ls -la ksuresult || true

    - name: Integrate KernelSU artifacts into AnyKernel
      run: |
        AK=anykernel
        mkdir -p $AK/modules/kernelsu
        if [ -d kernelsu/ksuresult ] && [ "$(ls -A kernelsu/ksuresult 2>/dev/null || true)" != "" ]; then
          echo "Copying KernelSU artifacts into AnyKernel modules"
          rsync -a kernelsu/ksuresult/ $AK/modules/kernelsu/ || true
        else
          echo "No KernelSU built artifacts found — skipping copy"
        fi
        if [ -d ./prebuilt_kernelsu ]; then
          echo "Found prebuilt_kernelsu in repo — copying into AnyKernel modules/"
          rsync -a ./prebuilt_kernelsu/ $AK/modules/kernelsu/ || true
        fi
        ls -la $AK/modules || true

    ####################################################################
    # Populate AnyKernel3 with kernel & modules
    ####################################################################

    - name: Populate AnyKernel3 with build artifacts & KernelSU
      run: |
        AK=anykernel
        mkdir -p $AK/kernel
        if [ -f "${{ env.KERNEL_DIR }}/out/arch/arm64/boot/Image.gz-dtb" ]; then cp "${{ env.KERNEL_DIR }}/out/arch/arm64/boot/Image.gz-dtb" $AK/kernel/Image.gz-dtb; fi
        if [ -f "${{ env.KERNEL_DIR }}/out/arch/arm64/boot/Image" ]; then cp "${{ env.KERNEL_DIR }}/out/arch/arm64/boot/Image" $AK/kernel/Image; fi
        if [ -f "${{ env.KERNEL_DIR }}/out/arch/arm64/boot/Image.gz" ]; then cp "${{ env.KERNEL_DIR }}/out/arch/arm64/boot/Image.gz" $AK/kernel/Image.gz; fi
        if [ -f "${{ env.KERNEL_DIR }}/out/arch/arm64/boot/dtbo.img" ]; then cp "${{ env.KERNEL_DIR }}/out/arch/arm64/boot/dtbo.img" $AK/kernel/dtbo.img; fi
        if [ -d modules_pkg/lib ]; then rsync -a modules_pkg/lib/ $AK/modules/ || true; fi
        # KernelSU modules (already copied in previous step)
        ls -la $AK/kernel || true
        ls -la $AK/modules || true

    - name: Prepare ramdisk (optional)
      run: |
        AK=anykernel
        if [ "${{ env.USE_STOCK_RAMDISK }}" = "true" ] && [ -f "./stock_boot.img" ]; then
          echo "Extracting ramdisk from stock_boot.img"
          abootimg -x stock_boot.img || true
          mkdir -p $AK/ramdisk
          gzip -dc ramdisk.cpio.gz | (cd $AK/ramdisk && cpio -idmv) || true
        elif [ -d "./ramdisk" ]; then
          echo "Using repo's ramdisk/"
          rsync -a ./ramdisk/ $AK/ramdisk/ || true
        else
          echo "No ramdisk provided; building kernel-only AnyKernel zip"
        fi

    - name: Build AnyKernel3 zip
      run: |
        AK=anykernel
        cd $AK
        vers="custom-optimized-${GITHUB_RUN_ID:-local}"
        echo "$vers" > Version || true
        zip -r9 ../anykernel-build-${{ github.run_number }}.zip . -x '*.git*' || true
        cd ..
        ls -lh anykernel-build-*.zip || true

    - name: Upload AnyKernel3 ZIP
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: anykernel-zip
        path: anykernel-build-*.zip

    ####################################################################
    # CRITICAL: Final disk cleanup (free runner space)
    ####################################################################

    - name: Final disk cleanup (free runner space)
      if: always()
      run: |
        echo "==== BEFORE CLEANUP ===="
        df -h || true
        sudo rm -rf $HOME/prebuilts || true
        sudo rm -rf kernelsu || true
        sudo rm -rf modules_pkg || true
        sudo rm -rf "${{ env.KERNEL_DIR }}/out/.cache" || true
        sudo apt-get clean || true
        sudo rm -rf /usr/share/dotnet || true
        sudo rm -rf /opt/ghc || true
        sudo rm -rf $HOME/.cargo || true
        echo "==== AFTER CLEANUP ===="
        df -h || true

    - name: Print final listings (debug)
      if: always()
      run: |
        echo "Kernel out dir listing (if exists):"
        ls -la "${{ env.KERNEL_DIR }}/out/arch/arm64/boot" || true
        echo "AnyKernel zip files:"
        ls -la anykernel-build-*.zip || true
        echo "AnyKernel modules (if present):"
        ls -la anykernel/modules || true
