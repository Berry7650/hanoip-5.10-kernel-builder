name: Hanoip Kernel 5.10 Build (Moto G40 Fusion)

on:
  workflow_dispatch:
  push:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-24.04

    steps:

    # 1. Checkout your repository (contains hanoip_defconfig.txt)
    - name: Checkout repo
      uses: actions/checkout@v4
      with:
        path: self-repo

    # 2. Install build dependencies (include curl)
    - name: Install required packages
      run: |
        sudo apt update
        sudo apt install -y bc bison flex build-essential lz4 ccache \
          libssl-dev libelf-dev libncurses5-dev python3 python3-pip git curl

    # 3. Clone Motorola Kernel 5.10 source code
    - name: Clone Motorola kernel source
      run: |
        git clone https://github.com/moto-common/android_kernel_motorola_msm-5.10.git kernel

    # 4. Clone Proton Clang toolchain
    - name: Clone Proton Clang
      run: |
        git clone https://github.com/kdrag0n/proton-clang.git clang

    # 5. Fix missing Motorola cc-wrapper
    - name: Fix missing Motorola cc-wrapper
      run: |
        if [ ! -f kernel/scripts/basic/cc-wrapper ]; then
          echo "Fixing: cc-wrapper missing..."
          curl -Lo kernel/scripts/basic/cc-wrapper \
            https://raw.githubusercontent.com/moto-common/android_kernel_motorola_sm6225/lineage-21/scripts/basic/cc-wrapper
          chmod +x kernel/scripts/basic/cc-wrapper
        else
          echo "cc-wrapper already exists; skipping."
        fi

    # 6. Setup environment for Clang cross-compiling
    - name: Setup environment variables
      run: |
        echo "ARCH=arm64" >> $GITHUB_ENV
        echo "SUBARCH=arm64" >> $GITHUB_ENV
        echo "CC=clang" >> $GITHUB_ENV
        echo "LLVM=1" >> $GITHUB_ENV

        TOOLCHAIN_PATH=$(realpath clang)
        echo "PATH=$TOOLCHAIN_PATH/bin:$PATH" >> $GITHUB_ENV
        echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV
        echo "CROSS_COMPILE_ARM32=arm-linux-gnueabi-" >> $GITHUB_ENV
        echo "CLANG_TRIPLE=aarch64-linux-gnu-" >> $GITHUB_ENV

    # 7. Apply your custom defconfig
    - name: Copy your custom defconfig
      run: |
        if [ -f self-repo/hanoip_defconfig.txt ]; then
          cp self-repo/hanoip_defconfig.txt kernel/arch/arm64/configs/hanoip_defconfig
        else
          echo "ERROR: self-repo/hanoip_defconfig.txt not found"
          exit 1
        fi

    # 8. Generate .config from your defconfig
    - name: Create config
      working-directory: kernel
      run: |
        make O=out hanoip_defconfig

    # 9. Compile the kernel
    - name: Build kernel
      working-directory: kernel
      run: |
        echo "Building with $(nproc) threads..."
        make -j$(nproc) O=out

    # 10. Output: Rename Image.lz4-dtb â†’ hanoip_kernel.img
    - name: Rename output image
      run: |
        OUT_IMG=kernel/out/arch/arm64/boot/Image.lz4-dtb
        if [ -f "$OUT_IMG" ]; then
          mv "$OUT_IMG" kernel/out/arch/arm64/boot/hanoip_kernel.img
        else
          echo "ERROR: expected output image not found at $OUT_IMG"
          ls -la kernel/out/arch/arm64/boot || true
          exit 1
        fi

    # 11. Upload compiled kernel
    - name: Upload Artifact
      uses: actions/upload-artifact@v4
      with:
        name: Hanoip-Kernel-${{ github.sha }}
        path: |
          kernel/out/arch/arm64/boot/hanoip_kernel.img
          kernel/out/arch/arm64/boot/dts/**/*.dtb
          kernel/out/arch/arm64/boot/dts/**/*.dtbo
        if-no-files-found: error
        retention-days: 7
