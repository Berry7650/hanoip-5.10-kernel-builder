name: Hanoip Kernel 5.10 Build (Moto G40 Fusion)

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest

    steps:

    # -----------------------------
    # 1. Checkout this repository
    # -----------------------------
    - name: Checkout Workflow Repository
      uses: actions/checkout@v4
      with:
        path: self-repo

    # ----------------------------------------
    # 2. Install required kernel build packages
    # ----------------------------------------
    - name: Install Build Dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          git build-essential bison flex libssl-dev libncurses5-dev \
          libelf-dev python3 python3-pip lz4 bc ccache

    # ----------------------------------------
    # 3. Clone Kernel Source + Clang Toolchain
    # ----------------------------------------
    - name: Clone Kernel Source and Toolchain
      run: |
        git clone https://github.com/moto-common/android_kernel_motorola_msm-5.10.git hanoip_kernel_510
        git clone https://github.com/kdrag0n/proton-clang.git clang-toolchain

    # ---------------------------------------------------------------
    # 4. Export environment variables for 64-bit Moto SD7xx compilation
    # ---------------------------------------------------------------
    - name: Set Environment Variables
      run: |
        TOOLCHAIN_PATH=$(realpath clang-toolchain)

        chmod -R +x $TOOLCHAIN_PATH/bin

        echo "ARCH=arm64" >> $GITHUB_ENV
        echo "SUBARCH=arm64" >> $GITHUB_ENV

        echo "PATH=$TOOLCHAIN_PATH/bin:$PATH" >> $GITHUB_ENV
        echo "CROSS_COMPILE=aarch64-linux-gnu-" >> $GITHUB_ENV
        echo "CROSS_COMPILE_ARM32=arm-linux-gnueabihf-" >> $GITHUB_ENV
        echo "CLANG_TRIPLE=aarch64-linux-gnu-" >> $GITHUB_ENV
        echo "CC=clang" >> $GITHUB_ENV

        echo "USE_CCACHE=1" >> $GITHUB_ENV

        echo "HOSTCC=/usr/bin/gcc" >> $GITHUB_ENV
        echo "HOSTLD=/usr/bin/ld" >> $GITHUB_ENV

    # ------------------------------------------
    # 5. Import Custom Defconfig & Generate .config
    # ------------------------------------------
    - name: Prepare Kernel Configuration
      run: |
        cd hanoip_kernel_510
        make O=out clean
        make O=out mrproper

        cp ../self-repo/hanoip_defconfig.txt arch/arm64/configs/hanoip_510_defconfig

        make O=out hanoip_510_defconfig HOSTLD=/usr/bin/ld
        make O=out olddefconfig HOSTLD=/usr/bin/ld

    # -------------------------
    # 6. Begin Kernel Build
    # -------------------------
    - name: Compile Kernel
      run: |
        cd hanoip_kernel_510
        echo "Starting build using $(nproc) threads..."
        make O=out -j$(nproc) HOSTLD=/usr/bin/ld

    # ---------------------------------------------------
    # 7. Rename final image to standard boot image format
    # ---------------------------------------------------
    - name: Package .img Output
      run: |
        mv hanoip_kernel_510/out/arch/arm64/boot/Image.lz4-dtb \
           hanoip_kernel_510/out/arch/arm64/boot/hanoip_kernel.img

    # ----------------------------------------------
    # 8. Upload artifact (.img kernel output)
    # ----------------------------------------------
    - name: Upload Built Kernel
      uses: actions/upload-artifact@v4
      with:
        name: hanoip-kernel-5.10-${{ github.sha }}
        path: hanoip_kernel_510/out/arch/arm64/boot/hanoip_kernel.img
        if-no-files-found: error
        retention-days: 7
